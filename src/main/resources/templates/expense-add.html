<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8">
  <title>Add Expense</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Include Bootstrap's JavaScript after jQuery -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <!-- Include jquery.dataTables.min.js after jQuery -->
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

 
</head>

<body>
  <div th:replace="~{fragments/navbar :: navbar}"></div>
  <div class="container my-8">
    <div class="row">
      <div class="col-md-6">
        <h1>Add Expense</h1>
        <form th:action="@{/expenses/save}" th:object="${expense}" method="post">
            <table class="table table-striped">
                <tr>
                    <td>
                      <div class="form-group">
                        <label for="district">District:</label>
                        <select class="form-control" id="district" name="district.did" required>
                          <option value="" selected>Select District</option>
                          <option th:each="district : ${districts}" th:value="${district.did}" th:text="${district.district}"></option>
                        </select>
                      </div>
                    </td>
                    
                    <td>
                      <div class="form-group">
                        <label for="lokal">Lokal:</label>
                        <select class="form-control" id="lokal" name="lokal" required>
                          <option value="" selected>Select Lokal</option>
                        </select>
                      </div>
                    </td>
                    </tr>
                    <tr>
                    <td>
                      <select class="form-control" id="wkno" name="wkno" required>
                        <option value="" selected>Select Week Number</option>
                        <script>
                          var year = moment().year(); // get the current year using moment.js
                          var startDate = moment(year + "-01-01").add(1, "week"); // start from the second week of the year
                          var endDate = moment(startDate).endOf("year");
                          var weeks = [];
                      
                          while (startDate.isBefore(endDate)) {
                            var weekNum = startDate.isoWeek();
                            var weekStr = ("0" + weekNum).slice(-2) + "-" + year;
                            weeks.push(weekStr);
                            startDate.add(1, "week");
                          }
                      
                          weeks.forEach(function (week) {
                            document.write('<option value="' + week + '">' + week + "</option>");
                          });
                        </script>
                        
                      </select>
                      
                      
                      
                      
                    </td>
                    <td>
                      <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea class="form-control" id="description" name="description" required></textarea>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="4">
                      <div class="form-group">
                        <label for="f10">F10:</label>
                        <input type="text" class="form-control" id="f10" name="f10" required>
                      </div>
                    </td>
                  </tr>
                  <tr>  
                    <td>
                      <div class="form-group">
                        <label for="amountRequested">Amount Requested:</label>
                        <input type="number" class="form-control" id="amountRequested" name="amountRequested" min="0" required>
                      </div>
                    </td>
                    <td>
                        <div class="form-group">
                          <label for="actualExpenses">Amount:</label>
                          <input type="number" class="form-control" id="actualExpenses" name="actualExpenses" min="0" required>
                        </div>
                      </td>
                   </tr>
                   <tr>
                    <td>
                      <div class="form-group">
                        <label for="datePurchased">Date Purchased:</label>
                        <input type="date" class="form-control" id="datePurchased" name="datePurchased" required>
                      </div>
                    </td>
                    <td>
                      <div class="form-group">
                        <label for="remarks">Remarks:</label>
                        <textarea class="form-control" id="remarks" name="remarks"></textarea>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="form-group">
                        <label for="qty">Quantity:</label>
                        <input type="number" class="form-control" id="qty" name="qty" min="0" required>
                      </div>
                    </td>
                    <td>
                      <div class="form-group">
                        <label for="exptype">Expense Type:</label>
                        <select class="form-control" id="exptype" name="exptype" required>
                          <option value="" selected>Select Expense Type</option>
                          <option value="Locale">Locale</option>
                          <option value="Central">Central</option>
                        </select>
                      </div>
                    </td>
                   </tr>
                   <tr>
                    <td colspan="4" class="text-center">
                      <button type="submit" class="btn btn-primary btn-lg">Add Expense</button>
                    </td>
                  </tr>
             </table>     
        </form>
    
      </div>
    
      <div class="col-md-6">
        <h2>Recent Expenses</h2>
        <table class="table table-striped">
          
          <tbody id="recentExpensesBody">
            <div id="recentExpensesTable"></div>
          </tbody>
        </table>
      </div>
    
    </div>
</div>    

  <script>
    $(document).ready(function () {
      $('#district').change(function () {
        var did = $(this).val();
        $.get('/getlocales/' + did, function (data) {  // @GetMapping("/getlocales/{districtId}")
          $('#lokal').empty();
          $('#lokal').append($('<option>').val('').text('Select Lokal'));
          $.each(data, function (i, lokal) {
            $('#lokal').append($('<option>').val(lokal.lcode).text(lokal.locale));
          });
        });
      });
    });
  </script>
<script>
 // Add an event listener to the form to update the recent expenses after submitting the form
 $("form").submit(function() {
  $.ajax({
    url: $(this).attr("action"),
    method: $(this).attr("method"),
    data: $(this).serialize(),
    success: function(data) {
      // Replace the contents of the recentExpensesTable div with the updated HTML
      $("#recentExpensesTable").html(data);
      
      // Reset the form
      $("form")[0].reset();
      $("#district").val("");
      $("#lokal").empty();
      $("#lokal").append($("<option>").val("").text("Select Lokal"));
    }
  });
  
  return false;
});

</script>
<script>
  $(document).ready(function() {
  // Event listener for edit expense button
  $(document).on("click", ".edit-expense-button", function() {
    var expenseId = $(this).data("expense-id");
    
    // Populate the modal with the expense data
    $.get("/expenses/" + expenseId, function(data) { // @GetMapping("/expenses/{id}")
      $("#editExpenseModal").find("#editExpenseId").val(data.id);
      $("#editExpenseModal").find("#editDistrict").val(data.district.did);
      $("#editExpenseModal").find("#editLokal").val(data.lokal);
      $("#editExpenseModal").find("#editWeekNumber").val(data.wkno);
      $("#editExpenseModal").find("#editDescription").val(data.description);
      $("#editExpenseModal").find("#editF10").val(data.f10);
      $("#editExpenseModal").find("#editAmountRequested").val(data.amountRequested);
      $("#editExpenseModal").find("#editActualExpenses").val(data.actualExpenses);
      $("#editExpenseModal").find("#editDatePurchased").val(data.datePurchased);
      $("#editExpenseModal").find("#editRemarks").val(data.remarks);
      $("#editExpenseModal").find("#editQuantity").val(data.qty);
      $("#editExpenseModal").find("#editExpenseType").val(data.exptype);
    });
    
    // Show the modal
    $("#editExpenseModal").modal("show");
  });
  
  // Event listener for submitting the edit expense form
  $("#editExpenseForm").submit(function(e) {
    e.preventDefault();
    
    $.ajax({
      url: $(this).attr("action"),
      method: $(this).attr("method"),
      data: $(this).serialize(),
      success: function(data) {
        // Close the modal
        $("#editExpenseModal").modal("hide");
        
        // Reload the recent expenses table
        $.get("/expenses/recent", function(data) { // @GetMapping("/expenses/recent")
          $("#recentExpensesBody").html(data);
        });
      },
      error: function(jqXHR, textStatus, errorThrown) {
        // Show an error message if the request fails
        alert("Error: " + textStatus + " - " + errorThrown);
      }
    });
  });
});

</script>
  <div class="container-fluid" th:replace="~{fragments/footer :: footer}"></div>
   <!-- Delete Modal -->
   <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this expense?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <form th:action="@{/expenses/delete/{id}(id=${expense.recid})}" method="post" id="deleteExpenseForm">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

